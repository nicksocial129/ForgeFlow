"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.middlewaresInterceptor = void 0;
const grpc_js_1 = require("@grpc/grpc-js");
const middleware_1 = require("../../config/middleware/middleware");
function middlewaresInterceptor(loggerFactory, middlewares, middlewareRequestContext) {
    return (options, nextCall) => {
        const middlewareRequestHandlers = middlewares.map(m => m.onNewRequest(middlewareRequestContext));
        // create a copy of the handlers and reverse it, because for the response life cycle actions we should call
        // the middlewares in the opposite order.
        const reversedMiddlewareRequestHandlers = [
            ...middlewareRequestHandlers,
        ].reverse();
        const requester = {
            start: function (metadata, listener, next) {
                const newListener = {
                    onReceiveMetadata: function (metadata, next) {
                        applyMiddlewareHandlers('onResponseMetadata', reversedMiddlewareRequestHandlers, (h) => (m) => h.onResponseMetadata(m), new middleware_1.MiddlewareMetadata(metadata), (metadata) => next(metadata._grpcMetadata));
                    },
                    onReceiveMessage: function (
                    // unfortunately grpc uses `any` in their type defs for these
                    // eslint-disable-next-line @typescript-eslint/no-explicit-any
                    message, 
                    // eslint-disable-next-line @typescript-eslint/no-explicit-any
                    next) {
                        applyMiddlewareHandlers('onResponseBody', reversedMiddlewareRequestHandlers, (h) => (request) => h.onResponseBody(request), new middleware_1.MiddlewareMessage(message), (msg) => next(msg === null || msg === void 0 ? void 0 : msg._grpcMessage));
                    },
                    onReceiveStatus: function (status, next) {
                        applyMiddlewareHandlers('onResponseStatus', reversedMiddlewareRequestHandlers, (h) => (s) => h.onResponseStatus(s), new middleware_1.MiddlewareStatus(status), (s) => next(s._grpcStatus));
                    },
                };
                applyMiddlewareHandlers('onRequestMetadata', middlewareRequestHandlers, (h) => (m) => h.onRequestMetadata(m), new middleware_1.MiddlewareMetadata(metadata), (m) => next(m._grpcMetadata, newListener));
            },
            // unfortunately grpc uses `any` in their type defs for these
            // eslint-disable-next-line @typescript-eslint/no-explicit-any
            sendMessage: function (message, next) {
                applyMiddlewareHandlers('onRequestBody', middlewareRequestHandlers, (h) => (request) => h.onRequestBody(request), new middleware_1.MiddlewareMessage(message), (m) => next(m._grpcMessage));
            },
        };
        return new grpc_js_1.InterceptingCall(nextCall(options), requester);
    };
}
exports.middlewaresInterceptor = middlewaresInterceptor;
function applyMiddlewareHandlers(name, handlers, middlewareHandlerReduceFn, originalInput, nextFn) {
    let remainingHandlers = handlers;
    let middlewarePromise = Promise.resolve(originalInput);
    while (remainingHandlers.length > 0) {
        const nextHandler = middlewareHandlerReduceFn(remainingHandlers[0]);
        middlewarePromise = middlewarePromise
            .then(newT => nextHandler(newT))
            .catch(e => {
            throw e;
        });
        remainingHandlers = remainingHandlers.slice(1);
    }
    middlewarePromise
        .then(newT => nextFn(newT))
        .catch(e => {
        throw e;
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWlkZGxld2FyZXMtaW50ZXJjZXB0b3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvaW50ZXJuYWwvZ3JwYy9taWRkbGV3YXJlcy1pbnRlcmNlcHRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwyQ0FRdUI7QUFFdkIsbUVBTzRDO0FBSTVDLFNBQWdCLHNCQUFzQixDQUNwQyxhQUFtQyxFQUNuQyxXQUF5QixFQUN6Qix3QkFBeUQ7SUFFekQsT0FBTyxDQUFDLE9BQTJCLEVBQUUsUUFBa0IsRUFBRSxFQUFFO1FBQ3pELE1BQU0seUJBQXlCLEdBQUcsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUNwRCxDQUFDLENBQUMsWUFBWSxDQUFDLHdCQUF3QixDQUFDLENBQ3pDLENBQUM7UUFDRiwyR0FBMkc7UUFDM0cseUNBQXlDO1FBQ3pDLE1BQU0saUNBQWlDLEdBQUc7WUFDeEMsR0FBRyx5QkFBeUI7U0FDN0IsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUVaLE1BQU0sU0FBUyxHQUFjO1lBQzNCLEtBQUssRUFBRSxVQUNMLFFBQWtCLEVBQ2xCLFFBQWtCLEVBQ2xCLElBQXNEO2dCQUV0RCxNQUFNLFdBQVcsR0FBYTtvQkFDNUIsaUJBQWlCLEVBQUUsVUFDakIsUUFBa0IsRUFDbEIsSUFBa0M7d0JBRWxDLHVCQUF1QixDQUNyQixvQkFBb0IsRUFDcEIsaUNBQWlDLEVBQ2pDLENBQUMsQ0FBMkIsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFxQixFQUFFLEVBQUUsQ0FDekQsQ0FBQyxDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQyxFQUN6QixJQUFJLCtCQUFrQixDQUFDLFFBQVEsQ0FBQyxFQUNoQyxDQUFDLFFBQTRCLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLENBQy9ELENBQUM7b0JBQ0osQ0FBQztvQkFDRCxnQkFBZ0IsRUFBRTtvQkFDaEIsNkRBQTZEO29CQUM3RCw4REFBOEQ7b0JBQzlELE9BQVk7b0JBQ1osOERBQThEO29CQUM5RCxJQUE0Qjt3QkFFNUIsdUJBQXVCLENBQ3JCLGdCQUFnQixFQUNoQixpQ0FBaUMsRUFDakMsQ0FBQyxDQUEyQixFQUFFLEVBQUUsQ0FDOUIsQ0FBQyxPQUFpQyxFQUFFLEVBQUUsQ0FDcEMsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsRUFDN0IsSUFBSSw4QkFBaUIsQ0FBQyxPQUFrQixDQUFDLEVBQ3pDLENBQUMsR0FBNkIsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLEdBQUcsYUFBSCxHQUFHLHVCQUFILEdBQUcsQ0FBRSxZQUFZLENBQUMsQ0FDM0QsQ0FBQztvQkFDSixDQUFDO29CQUNELGVBQWUsRUFBRSxVQUNmLE1BQW9CLEVBQ3BCLElBQW9DO3dCQUVwQyx1QkFBdUIsQ0FDckIsa0JBQWtCLEVBQ2xCLGlDQUFpQyxFQUNqQyxDQUFDLENBQTJCLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBbUIsRUFBRSxFQUFFLENBQ3ZELENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsRUFDdkIsSUFBSSw2QkFBZ0IsQ0FBQyxNQUFNLENBQUMsRUFDNUIsQ0FBQyxDQUFtQixFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUM3QyxDQUFDO29CQUNKLENBQUM7aUJBQ0YsQ0FBQztnQkFFRix1QkFBdUIsQ0FDckIsbUJBQW1CLEVBQ25CLHlCQUF5QixFQUN6QixDQUFDLENBQTJCLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBcUIsRUFBRSxFQUFFLENBQ3pELENBQUMsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLENBQUMsRUFDeEIsSUFBSSwrQkFBa0IsQ0FBQyxRQUFRLENBQUMsRUFDaEMsQ0FBQyxDQUFxQixFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLGFBQWEsRUFBRSxXQUFXLENBQUMsQ0FDOUQsQ0FBQztZQUNKLENBQUM7WUFDRCw2REFBNkQ7WUFDN0QsOERBQThEO1lBQzlELFdBQVcsRUFBRSxVQUFVLE9BQVksRUFBRSxJQUE0QjtnQkFDL0QsdUJBQXVCLENBQ3JCLGVBQWUsRUFDZix5QkFBeUIsRUFDekIsQ0FBQyxDQUEyQixFQUFFLEVBQUUsQ0FBQyxDQUFDLE9BQTBCLEVBQUUsRUFBRSxDQUM5RCxDQUFDLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxFQUMxQixJQUFJLDhCQUFpQixDQUFDLE9BQWtCLENBQUMsRUFDekMsQ0FBQyxDQUFvQixFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUMvQyxDQUFDO1lBQ0osQ0FBQztTQUNGLENBQUM7UUFDRixPQUFPLElBQUksMEJBQWdCLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQzVELENBQUMsQ0FBQztBQUNKLENBQUM7QUEzRkQsd0RBMkZDO0FBRUQsU0FBUyx1QkFBdUIsQ0FDOUIsSUFBWSxFQUNaLFFBQW9DLEVBQ3BDLHlCQUV5QixFQUN6QixhQUFnQixFQUNoQixNQUFzQjtJQUV0QixJQUFJLGlCQUFpQixHQUFHLFFBQVEsQ0FBQztJQUNqQyxJQUFJLGlCQUFpQixHQUFlLE9BQU8sQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDbkUsT0FBTyxpQkFBaUIsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1FBQ25DLE1BQU0sV0FBVyxHQUFHLHlCQUF5QixDQUFDLGlCQUFpQixDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDcEUsaUJBQWlCLEdBQUcsaUJBQWlCO2FBQ2xDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUMvQixLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDVCxNQUFNLENBQUMsQ0FBQztRQUNWLENBQUMsQ0FBQyxDQUFDO1FBQ0wsaUJBQWlCLEdBQUcsaUJBQWlCLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQ2hEO0lBRUQsaUJBQWlCO1NBQ2QsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQzFCLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRTtRQUNULE1BQU0sQ0FBQyxDQUFDO0lBQ1YsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgSW50ZXJjZXB0aW5nQ2FsbCxcbiAgSW50ZXJjZXB0b3IsXG4gIEludGVyY2VwdG9yT3B0aW9ucyxcbiAgTGlzdGVuZXIsXG4gIE1ldGFkYXRhLFxuICBSZXF1ZXN0ZXIsXG4gIFN0YXR1c09iamVjdCxcbn0gZnJvbSAnQGdycGMvZ3JwYy1qcyc7XG5pbXBvcnQge05leHRDYWxsfSBmcm9tICdAZ3JwYy9ncnBjLWpzL2J1aWxkL3NyYy9jbGllbnQtaW50ZXJjZXB0b3JzJztcbmltcG9ydCB7XG4gIE1pZGRsZXdhcmUsXG4gIE1pZGRsZXdhcmVNZXNzYWdlLFxuICBNaWRkbGV3YXJlTWV0YWRhdGEsXG4gIE1pZGRsZXdhcmVSZXF1ZXN0SGFuZGxlcixcbiAgTWlkZGxld2FyZVJlcXVlc3RIYW5kbGVyQ29udGV4dCxcbiAgTWlkZGxld2FyZVN0YXR1cyxcbn0gZnJvbSAnLi4vLi4vY29uZmlnL21pZGRsZXdhcmUvbWlkZGxld2FyZSc7XG5pbXBvcnQge01lc3NhZ2V9IGZyb20gJ2dvb2dsZS1wcm90b2J1Zic7XG5pbXBvcnQge01vbWVudG9Mb2dnZXJGYWN0b3J5fSBmcm9tICcuLi8uLi8nO1xuXG5leHBvcnQgZnVuY3Rpb24gbWlkZGxld2FyZXNJbnRlcmNlcHRvcihcbiAgbG9nZ2VyRmFjdG9yeTogTW9tZW50b0xvZ2dlckZhY3RvcnksXG4gIG1pZGRsZXdhcmVzOiBNaWRkbGV3YXJlW10sXG4gIG1pZGRsZXdhcmVSZXF1ZXN0Q29udGV4dDogTWlkZGxld2FyZVJlcXVlc3RIYW5kbGVyQ29udGV4dFxuKTogSW50ZXJjZXB0b3Ige1xuICByZXR1cm4gKG9wdGlvbnM6IEludGVyY2VwdG9yT3B0aW9ucywgbmV4dENhbGw6IE5leHRDYWxsKSA9PiB7XG4gICAgY29uc3QgbWlkZGxld2FyZVJlcXVlc3RIYW5kbGVycyA9IG1pZGRsZXdhcmVzLm1hcChtID0+XG4gICAgICBtLm9uTmV3UmVxdWVzdChtaWRkbGV3YXJlUmVxdWVzdENvbnRleHQpXG4gICAgKTtcbiAgICAvLyBjcmVhdGUgYSBjb3B5IG9mIHRoZSBoYW5kbGVycyBhbmQgcmV2ZXJzZSBpdCwgYmVjYXVzZSBmb3IgdGhlIHJlc3BvbnNlIGxpZmUgY3ljbGUgYWN0aW9ucyB3ZSBzaG91bGQgY2FsbFxuICAgIC8vIHRoZSBtaWRkbGV3YXJlcyBpbiB0aGUgb3Bwb3NpdGUgb3JkZXIuXG4gICAgY29uc3QgcmV2ZXJzZWRNaWRkbGV3YXJlUmVxdWVzdEhhbmRsZXJzID0gW1xuICAgICAgLi4ubWlkZGxld2FyZVJlcXVlc3RIYW5kbGVycyxcbiAgICBdLnJldmVyc2UoKTtcblxuICAgIGNvbnN0IHJlcXVlc3RlcjogUmVxdWVzdGVyID0ge1xuICAgICAgc3RhcnQ6IGZ1bmN0aW9uIChcbiAgICAgICAgbWV0YWRhdGE6IE1ldGFkYXRhLFxuICAgICAgICBsaXN0ZW5lcjogTGlzdGVuZXIsXG4gICAgICAgIG5leHQ6IChtZXRhZGF0YTogTWV0YWRhdGEsIGxpc3RlbmVyOiBMaXN0ZW5lcikgPT4gdm9pZFxuICAgICAgKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IG5ld0xpc3RlbmVyOiBMaXN0ZW5lciA9IHtcbiAgICAgICAgICBvblJlY2VpdmVNZXRhZGF0YTogZnVuY3Rpb24gKFxuICAgICAgICAgICAgbWV0YWRhdGE6IE1ldGFkYXRhLFxuICAgICAgICAgICAgbmV4dDogKG1ldGFkYXRhOiBNZXRhZGF0YSkgPT4gdm9pZFxuICAgICAgICAgICk6IHZvaWQge1xuICAgICAgICAgICAgYXBwbHlNaWRkbGV3YXJlSGFuZGxlcnMoXG4gICAgICAgICAgICAgICdvblJlc3BvbnNlTWV0YWRhdGEnLFxuICAgICAgICAgICAgICByZXZlcnNlZE1pZGRsZXdhcmVSZXF1ZXN0SGFuZGxlcnMsXG4gICAgICAgICAgICAgIChoOiBNaWRkbGV3YXJlUmVxdWVzdEhhbmRsZXIpID0+IChtOiBNaWRkbGV3YXJlTWV0YWRhdGEpID0+XG4gICAgICAgICAgICAgICAgaC5vblJlc3BvbnNlTWV0YWRhdGEobSksXG4gICAgICAgICAgICAgIG5ldyBNaWRkbGV3YXJlTWV0YWRhdGEobWV0YWRhdGEpLFxuICAgICAgICAgICAgICAobWV0YWRhdGE6IE1pZGRsZXdhcmVNZXRhZGF0YSkgPT4gbmV4dChtZXRhZGF0YS5fZ3JwY01ldGFkYXRhKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9LFxuICAgICAgICAgIG9uUmVjZWl2ZU1lc3NhZ2U6IGZ1bmN0aW9uIChcbiAgICAgICAgICAgIC8vIHVuZm9ydHVuYXRlbHkgZ3JwYyB1c2VzIGBhbnlgIGluIHRoZWlyIHR5cGUgZGVmcyBmb3IgdGhlc2VcbiAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG4gICAgICAgICAgICBtZXNzYWdlOiBhbnksXG4gICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuICAgICAgICAgICAgbmV4dDogKG1lc3NhZ2U6IGFueSkgPT4gdm9pZFxuICAgICAgICAgICk6IHZvaWQge1xuICAgICAgICAgICAgYXBwbHlNaWRkbGV3YXJlSGFuZGxlcnMoXG4gICAgICAgICAgICAgICdvblJlc3BvbnNlQm9keScsXG4gICAgICAgICAgICAgIHJldmVyc2VkTWlkZGxld2FyZVJlcXVlc3RIYW5kbGVycyxcbiAgICAgICAgICAgICAgKGg6IE1pZGRsZXdhcmVSZXF1ZXN0SGFuZGxlcikgPT5cbiAgICAgICAgICAgICAgICAocmVxdWVzdDogTWlkZGxld2FyZU1lc3NhZ2UgfCBudWxsKSA9PlxuICAgICAgICAgICAgICAgICAgaC5vblJlc3BvbnNlQm9keShyZXF1ZXN0KSxcbiAgICAgICAgICAgICAgbmV3IE1pZGRsZXdhcmVNZXNzYWdlKG1lc3NhZ2UgYXMgTWVzc2FnZSksXG4gICAgICAgICAgICAgIChtc2c6IE1pZGRsZXdhcmVNZXNzYWdlIHwgbnVsbCkgPT4gbmV4dChtc2c/Ll9ncnBjTWVzc2FnZSlcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfSxcbiAgICAgICAgICBvblJlY2VpdmVTdGF0dXM6IGZ1bmN0aW9uIChcbiAgICAgICAgICAgIHN0YXR1czogU3RhdHVzT2JqZWN0LFxuICAgICAgICAgICAgbmV4dDogKHN0YXR1czogU3RhdHVzT2JqZWN0KSA9PiB2b2lkXG4gICAgICAgICAgKTogdm9pZCB7XG4gICAgICAgICAgICBhcHBseU1pZGRsZXdhcmVIYW5kbGVycyhcbiAgICAgICAgICAgICAgJ29uUmVzcG9uc2VTdGF0dXMnLFxuICAgICAgICAgICAgICByZXZlcnNlZE1pZGRsZXdhcmVSZXF1ZXN0SGFuZGxlcnMsXG4gICAgICAgICAgICAgIChoOiBNaWRkbGV3YXJlUmVxdWVzdEhhbmRsZXIpID0+IChzOiBNaWRkbGV3YXJlU3RhdHVzKSA9PlxuICAgICAgICAgICAgICAgIGgub25SZXNwb25zZVN0YXR1cyhzKSxcbiAgICAgICAgICAgICAgbmV3IE1pZGRsZXdhcmVTdGF0dXMoc3RhdHVzKSxcbiAgICAgICAgICAgICAgKHM6IE1pZGRsZXdhcmVTdGF0dXMpID0+IG5leHQocy5fZ3JwY1N0YXR1cylcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfSxcbiAgICAgICAgfTtcblxuICAgICAgICBhcHBseU1pZGRsZXdhcmVIYW5kbGVycyhcbiAgICAgICAgICAnb25SZXF1ZXN0TWV0YWRhdGEnLFxuICAgICAgICAgIG1pZGRsZXdhcmVSZXF1ZXN0SGFuZGxlcnMsXG4gICAgICAgICAgKGg6IE1pZGRsZXdhcmVSZXF1ZXN0SGFuZGxlcikgPT4gKG06IE1pZGRsZXdhcmVNZXRhZGF0YSkgPT5cbiAgICAgICAgICAgIGgub25SZXF1ZXN0TWV0YWRhdGEobSksXG4gICAgICAgICAgbmV3IE1pZGRsZXdhcmVNZXRhZGF0YShtZXRhZGF0YSksXG4gICAgICAgICAgKG06IE1pZGRsZXdhcmVNZXRhZGF0YSkgPT4gbmV4dChtLl9ncnBjTWV0YWRhdGEsIG5ld0xpc3RlbmVyKVxuICAgICAgICApO1xuICAgICAgfSxcbiAgICAgIC8vIHVuZm9ydHVuYXRlbHkgZ3JwYyB1c2VzIGBhbnlgIGluIHRoZWlyIHR5cGUgZGVmcyBmb3IgdGhlc2VcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG4gICAgICBzZW5kTWVzc2FnZTogZnVuY3Rpb24gKG1lc3NhZ2U6IGFueSwgbmV4dDogKG1lc3NhZ2U6IGFueSkgPT4gdm9pZCk6IHZvaWQge1xuICAgICAgICBhcHBseU1pZGRsZXdhcmVIYW5kbGVycyhcbiAgICAgICAgICAnb25SZXF1ZXN0Qm9keScsXG4gICAgICAgICAgbWlkZGxld2FyZVJlcXVlc3RIYW5kbGVycyxcbiAgICAgICAgICAoaDogTWlkZGxld2FyZVJlcXVlc3RIYW5kbGVyKSA9PiAocmVxdWVzdDogTWlkZGxld2FyZU1lc3NhZ2UpID0+XG4gICAgICAgICAgICBoLm9uUmVxdWVzdEJvZHkocmVxdWVzdCksXG4gICAgICAgICAgbmV3IE1pZGRsZXdhcmVNZXNzYWdlKG1lc3NhZ2UgYXMgTWVzc2FnZSksXG4gICAgICAgICAgKG06IE1pZGRsZXdhcmVNZXNzYWdlKSA9PiBuZXh0KG0uX2dycGNNZXNzYWdlKVxuICAgICAgICApO1xuICAgICAgfSxcbiAgICB9O1xuICAgIHJldHVybiBuZXcgSW50ZXJjZXB0aW5nQ2FsbChuZXh0Q2FsbChvcHRpb25zKSwgcmVxdWVzdGVyKTtcbiAgfTtcbn1cblxuZnVuY3Rpb24gYXBwbHlNaWRkbGV3YXJlSGFuZGxlcnM8VD4oXG4gIG5hbWU6IHN0cmluZyxcbiAgaGFuZGxlcnM6IE1pZGRsZXdhcmVSZXF1ZXN0SGFuZGxlcltdLFxuICBtaWRkbGV3YXJlSGFuZGxlclJlZHVjZUZuOiAoXG4gICAgaDogTWlkZGxld2FyZVJlcXVlc3RIYW5kbGVyXG4gICkgPT4gKHQ6IFQpID0+IFByb21pc2U8VD4sXG4gIG9yaWdpbmFsSW5wdXQ6IFQsXG4gIG5leHRGbjogKHQ6IFQpID0+IHZvaWRcbikge1xuICBsZXQgcmVtYWluaW5nSGFuZGxlcnMgPSBoYW5kbGVycztcbiAgbGV0IG1pZGRsZXdhcmVQcm9taXNlOiBQcm9taXNlPFQ+ID0gUHJvbWlzZS5yZXNvbHZlKG9yaWdpbmFsSW5wdXQpO1xuICB3aGlsZSAocmVtYWluaW5nSGFuZGxlcnMubGVuZ3RoID4gMCkge1xuICAgIGNvbnN0IG5leHRIYW5kbGVyID0gbWlkZGxld2FyZUhhbmRsZXJSZWR1Y2VGbihyZW1haW5pbmdIYW5kbGVyc1swXSk7XG4gICAgbWlkZGxld2FyZVByb21pc2UgPSBtaWRkbGV3YXJlUHJvbWlzZVxuICAgICAgLnRoZW4obmV3VCA9PiBuZXh0SGFuZGxlcihuZXdUKSlcbiAgICAgIC5jYXRjaChlID0+IHtcbiAgICAgICAgdGhyb3cgZTtcbiAgICAgIH0pO1xuICAgIHJlbWFpbmluZ0hhbmRsZXJzID0gcmVtYWluaW5nSGFuZGxlcnMuc2xpY2UoMSk7XG4gIH1cblxuICBtaWRkbGV3YXJlUHJvbWlzZVxuICAgIC50aGVuKG5ld1QgPT4gbmV4dEZuKG5ld1QpKVxuICAgIC5jYXRjaChlID0+IHtcbiAgICAgIHRocm93IGU7XG4gICAgfSk7XG59XG4iXX0=